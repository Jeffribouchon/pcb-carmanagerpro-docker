{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Recherche Annonces</h2>
  <p style="font-style: italic; color: gray; margin-top: -10px;">
    Décrivez le véhicule que vous cherchez, votre agent IA Turbo RIDER génère automatiquement les URL de recherche
    sur Le Bon Coin, La Centrale, et Autoscout24.
  </p>

  <form method="post" class="mb-3" id="aiForm">
    <textarea name="query" class="form-control" placeholder="Ex: Je cherche une Peugeot 208 essence boîte manuelle, max 15k€..." rows="4"></textarea>
    <button type="submit" class="btn btn-primary mt-2">Générer les recherches</button>
  </form>

  {% if error %}
    <div class="alert alert-danger mt-3">{{ error }}</div>
  {% endif %}

  {% if criteria %}
    <h5>Critères extraits :</h5>
    <pre>
      {% for key, value in criteria.items() if value is not none -%}
      {{ key }}: {{ value }}
      {% endfor %}
    </pre>
  {% endif %}
  
  {% if results %}
    {% for site, data in results.items() %}
      <!-- Encadré du site avec bouton -->
      <div class="card mb-1">
        <div class="card-body d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Annonces {{ site }}</h5>
          <a href="{{ data.url }}" class="btn btn-sm btn-primary" target="_blank">
            Rechercher
          </a>
        </div>
      </div>
  
      {% if data.ads_results %}
        <div class="table-responsive mt-1 mb-3">
          <table class="table table-bordered table-hover mb-0 datatable">
            <thead>
              <tr>
                <th>Titre</th>
                <th>Carburant</th>
                <th>Boite vitesse</th>
                <th>Millésime</th>
                <th>Kilométrage</th>
                <th>Prix</th>
                <th>Ville</th>
                <th>Lien</th>
              </tr>
            </thead>
            <tbody>
              {% for ad in data.ads_results %}
              <tr>
                <td>{{ ad.title }}</td>
                <td>{{ ad.fuel }}</td>
                <td>{{ ad.gearbox }}</td>
                <td>{{ ad.year }}</td>
                <td>{{ ad.mileage }}</td>
                <td>{{ ad.price }}</td>
                <td>{{ ad.city }}</td>
                <td><a href="{{ ad.url }}" target="_blank" class="btn btn-sm btn-secondary">Voir</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
      <div class="mb-4"></div>
    {% endfor %}
  {% endif %}
</div>

<!-- Ajout des scripts DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function () {
    $('.datatable').DataTable({
      "order": [[5, "asc"]], // Tri par prix par défaut
      "pageLength": 10,
      "language": {
        "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
      }
    });
  });
</script>
{% endblock %}
